# 如何实现session跨服务器共享

当使用多台服务器架设成集群之后，我们通过负载均衡的方式，同一个用户（或者ip）访问时被分配到不同的服务器上，假设在A服务器登录，如果在B服务器拿不到用户的登录信息session。这时访问到B服务器时就出现未登录情况。

Session 共享有多种解决方案，常用的有四种：

- #### 客户端 Cookie 保存

- #### 服务器间 Session 同步

- #### 使用集群管理 Session

- #### Session 持久化到数据库



## 客户端 Cookie 保存

以 Cookie 加密的方式保存在客户端，每次 session 信息都被写在客户端，然后经过浏览器再次提交到服务器，及时两次请求在集群中的两台服务器上完成，也可以达到 session 共享。

优点：减轻服务器端压力

缺点：收到 Cookie 的大小限制，可能占用一定带宽，因为每次请求都会在头部附带一定大小的 cookie 信息，另外这种方式在用户禁止使用 cookie 的情况下无效。

传统网站一般通过将一部分数据存储在 cookie 中，来规避分布式环境下 session 的操作。

这样做的弊端有：一方面 cookie 的安全性得不到保障，另一方面 cookie 存储数据的大小有所限制。

随着移动互联网的发展，很多情况下需要兼容移动端的 session 需求，这样采用 cookie 来进行 session 同步的缺点更为明显，这样就产生了分布式 session。



## 服务器间 Session 同步

定时同步各个服务器的 session 信息，此方法可能会有一定的延时，用户体验也不是很好。使用主-从 服务器的架构，当用户在主服务器上登录后，通过脚本或者守护进程的方式，将 Session 信息传递到各个从服务器中，也可以手工把 Session 文件存放的目录改为 NFS 网络文件系统，从而实现文件的跨机器访问，用户访问其他的从服务器时，就可以读到 session 信息。

缺点：因为是文件同步，就会造成速度慢，不稳定等因素。如果 session 信息传递是 主-》从 单向的，就会有一定风险，如果主服务器 down 掉，其他服务器就无法获得 session 信息。



## Session 持久化到数据库

这种共享 session 的方式是将 session 信息存入到数据库中，其他应用可以从数据可以从数据库查出 session 信息。目前采用这种方案时所使用的的数据库一般是 MySQL。

利用数据共享 session 的方案有一定的实用性，但也有缺点：

- session 的并发读写在数据库中完成，对MySQL 的性能要求较高
- 需要额为实现 session 淘汰逻辑代码，定时从数据库中更新和删除 session 信息，加大了工作量
- 对系统可靠性要求较高的用户，可以将 session 持久化到 DB 中，这样保证服务器宕机时回话不易丢失，但是系统整体吞吐也会受到很大影响



## 使用集群管理 Session

将 session 统一存储到缓存集群上，如 memcache ，这样可以保证较高的读，写性能，这一点对于并发量大的系统来说非常重要；

并且从安全性考虑，session 是有有效期的，使用缓存存储，便于利用缓存的失效机制。

缺点：一旦缓存重启，里边保存的会话也就消失，需要用户重新建立会话，可以使用缓存集群来保证缓存的稳定性。



## 基于缓存的分布式session架构



![img](https://cdn.nlark.com/yuque/0/2020/svg/282255/1595555530965-45c153e7-8780-4687-bc8d-3f36259dcf11.svg)



如图所示，前端用户请求经过随机分发之后，可能会命中后端任意的 Web Server ,将 session 以 sessionid 作为 key，保存到后端的缓存集群中，使得不管请求如何分配，即便是某个 Web Server 宕机，也不会影响其他 Web Server 获取 session，这样既实现了集群间的 session 同步，又提高了 Web Server 的容错性。



## 资料：

https://www.cnblogs.com/liluxiang/p/9377631.html